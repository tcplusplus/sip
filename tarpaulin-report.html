<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
}

.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","tomc","rust","sir","src","main.rs"],"content":"mod world;\nuse world::world::World;\nuse world::person::PersonState;\nuse world::virus::Virus;\nuse pixel_canvas::{Canvas, Color, input::MouseState, RC, image};\nuse std::time::{SystemTime};\n\nfn color_pixel(image: \u0026mut image::Image, x: isize, y: isize, state: \u0026world::person::PersonState) {\n    let width = image.width() as isize;\n    let height = image.height() as isize;\n    let size = 1;\n    for i in y-size..y+size+1 {\n        if i \u003e= 0 \u0026\u0026 i \u003c height {\n            for j in x-size..x+size+1 {\n                if j \u003e= 0 \u0026\u0026 j \u003c width {\n                    let mut pix: \u0026mut Color = \u0026mut image[RC(i as usize, j as usize)];\n                    match state {\n                        PersonState::Susceptible =\u003e pix.g = 255,\n                        PersonState::Infectious =\u003e pix.r = 255,\n                        PersonState::Recovered(false) =\u003e pix.b = 255,\n                        PersonState::Recovered(true) =\u003e {\n                            pix.r = 255;\n                            pix.g = 255;\n                            pix.b = 255;\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\nfn plot_graph(image: \u0026mut image::Image, stats: \u0026Vec\u003c(f32, f32, f32)\u003e, line_start: usize, line_end: usize) {\n    let width = image.width() as usize;\n    for (y, row) in image.chunks_mut(width).enumerate() {\n        for (x, pixel) in row.iter_mut().enumerate() {\n            if y \u003e line_start {\n                let mut r = 255;\n                let mut g = 255;\n                let mut b = 255;\n                if x \u003c stats.len() {\n                    let percent = 1.0 - ((line_end as f32) - (y as f32)) / ((line_end as f32) - (line_start as f32));\n                    if stats[x].1 \u003e percent {\n                        b = 0;\n                        g = 0;\n                    } else if stats[x].0 + stats[x].1 \u003e percent {\n                        r = 0;\n                        b = 0;\n                    } else {\n                        r = 0;\n                        g = 0;\n                    }\n                }\n                *pixel = Color { r, g, b };\n            }\n\n        }\n    }\n}\n\nfn main() {\n    let graph_size = 200;\n    let mut world = World::new(3000, 1920, 1080 - graph_size);\n    world.config(15);\n    let virus = Virus::corona();\n    world.set_virus(\u0026virus);\n\n    let canvas = Canvas::new(world.get_width(), world.get_height() + graph_size)\n        .title(\"World\")\n        .state(MouseState::new())\n        .input(MouseState::handle_input);\n\n    let mut now = SystemTime::now();\n    let mut stats: Vec\u003c(f32, f32, f32)\u003e = Vec::new();\n    // The canvas will render for you at up to 60fps.\n    canvas.render(move |_mouse, image| {\n        match now.elapsed() {\n            Ok(elapsed) =\u003e {\n                println!(\"{} ms\", elapsed.as_millis());\n            }\n            Err(e) =\u003e {\n                println!(\"Error: {:?}\", e);\n            }\n        }\n        now = SystemTime::now();\n        image.fill(Color {r: 0, g: 0, b: 0});\n\n        let mut count: (usize, usize, usize) = (0, 0, 0);\n        for person in world.people.iter_mut() {\n            color_pixel(image, person.position.x, person.position.y, \u0026person.get_state());\n            match person.get_state() {\n                PersonState::Susceptible =\u003e count.0 += 1,\n                PersonState::Infectious =\u003e count.1 += 1,\n                PersonState::Recovered(_dead) =\u003e count.2 += 1\n            }\n        };\n        let total = (count.0 + count.1 + count.2) as f32;\n        stats.push(((count.0 as f32) / total, (count.1 as f32) / total, (count.2 as f32) / total));\n        //println!(\"\u003e\u003e {:?} \", stats);\n        plot_graph(image, \u0026stats, world.get_height(), world.get_height() + graph_size);\n        world.update();\n    });\n}","traces":[{"line":8,"address":[4688640],"length":1,"stats":{"Line":0},"fn_name":"color_pixel"},{"line":9,"address":[4688711],"length":1,"stats":{"Line":0},"fn_name":null},{"line":10,"address":[4688749],"length":1,"stats":{"Line":0},"fn_name":null},{"line":11,"address":[4688773],"length":1,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[4689622,4688793,4689003],"length":1,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[4689037,4689311],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[4689109,4689617,4689316,4689717],"length":1,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[4689350,4689615],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[4689422],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[4689581,4689594,4689604],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[4689499,4689590],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[4689601],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[4689611,4689560],"length":1,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[4689570],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[4689573],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[4689577],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[4689808],"length":1,"stats":{"Line":0},"fn_name":"plot_graph"},{"line":34,"address":[4689879],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[4689909,4690489,4690122],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[4690316,4690494,4691219,4691224],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[4690573],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[4690592],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[4690600],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[4690608],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[4691149,4690624],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[4690670],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[4691048,4690976,4691147],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[4691032],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[4691040],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[4691020,4691055,4691129],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[4691131],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[4691139],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[4691113],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[4691121],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[4691151],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[4691305,4691232],"length":1,"stats":{"Line":0},"fn_name":"main"},{"line":62,"address":[4691239],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[4691320,4692139,4691275],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[4691363],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[4691378],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[4691398],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[4691621,4691558,4692189,4691410],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[4692069,4691597,4691539],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[4691628],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[4691636],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[4691711],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[4691718],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[4759263,4759430,4759783,4759675],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[4759302,4759432],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[4759462],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[4759324],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[4759354,4759685],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[4759785],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[4759838],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[4759918],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[4760544,4759962,4760185],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[4760219],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[4760434,4760311,4760526,4760480],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[4761243,4760323,4760436],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[4761213,4760482],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[4760382,4761183,4760536],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[4760144,4760557,4761273],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[4760671],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[4761025,4761363,4761333],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[4761161],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":65},{"path":["/","home","tomc","rust","sir","src","world","person.rs"],"content":"use rand::Rng;\nuse rand::rngs::ThreadRng;\nuse std::cmp;\n\n#[derive(Debug, PartialEq, Clone)]\npub enum PersonState {\n  Susceptible,\n  Infectious,\n  Recovered(bool)\n}\n\n#[derive(Clone, Debug)]\npub struct Location {\n  pub x: isize,\n  pub y: isize\n}\n\n#[derive(Debug, Clone)]\npub struct Person {\n  state: PersonState,\n  infected_date: isize,\n  age: isize,\n  pub position: Location,\n  home: Location,\n  rng: ThreadRng\n}\n\nimpl Person {\n  pub fn new_random(max_x: usize, max_y: usize) -\u003e Person {\n    let mut rng = rand::thread_rng();\n    let position = Location {\n      x: rng.gen_range(0, max_x as isize),\n      y: rng.gen_range(0, max_y as isize)\n    };\n    Person {\n      state: PersonState::Susceptible,\n      age: 0,\n      infected_date: 0,\n      home: position.clone(),\n      position,\n      rng\n    }\n  }\n  pub fn get_state(\u0026self) -\u003e PersonState {\n    self.state.clone()\n  }\n  pub fn infect(\u0026mut self, infection_rate: f32) {\n    let chance = self.rng.gen_range(0.0, 1.0);\n    if chance \u003c= infection_rate {\n      self.state = PersonState::Infectious;\n      self.infected_date = self.age;\n    }\n  }\n  pub fn update_age(\u0026mut self, max_infected_age: usize, mortality_rate: f32) {\n    self.age += 1;\n    let max_infected_age: isize = max_infected_age as isize;\n    if self.state == PersonState::Infectious \u0026\u0026 self.infected_date \u003c self.age - max_infected_age {\n      let chance = self.rng.gen_range(0.0, 1.0);\n      self.state = PersonState::Recovered(chance \u003c mortality_rate);\n    }\n  }\n  pub fn move_random(\u0026mut self, max_speed: usize, max_x: usize, max_y: usize) {\n    let mut max_speed: isize = max_speed as isize;\n    if let PersonState::Recovered(is_dead) = self.state {\n      if is_dead {\n        max_speed = 0\n      }\n    }\n    let x: isize = self.position.x as isize;\n    let y: isize = self.position.y as isize;\n\n    let mut new_x = x + self.rng.gen_range(-max_speed, max_speed+1);\n    let mut new_y = y + self.rng.gen_range(-max_speed, max_speed+1);\n    let max_x: isize = max_x as isize;\n    let max_y: isize = max_y as isize;\n    if new_x \u003e= max_x {\n      new_x = 0\n    };\n    if new_y \u003e= max_y {\n      new_y = 0\n    }\n    if new_x \u003c 0 {\n      new_x = max_x - 1;\n    };\n    if new_y  \u003c 0 {\n      new_y = max_y - 1;\n    }\n    self.position.x = new_x;\n    self.position.y = new_y;\n  }\n  fn min_diff(x1: isize, x2: isize, width: isize) -\u003e isize {\n    let diff_1 = (x1 - x2).abs();\n    let diff_2 = (diff_1 - width).abs();\n    std::cmp::min(diff_1, diff_2)\n  }\n  // We need the world to know its size because the world is circular\n  pub fn sqr_distance(\u0026self, other: \u0026Person, world_width: usize, world_height: usize) -\u003e isize {\n    let diff_x = Person::min_diff(self.position.x, other.position.x, world_width as isize);\n    let diff_y = Person::min_diff(self.position.y, other.position.y, world_height as isize);\n    return diff_x * diff_x + diff_y * diff_y;\n  }\n}","traces":[{"line":29,"address":[4692688],"length":1,"stats":{"Line":1},"fn_name":"new_random"},{"line":30,"address":[4692725],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[4692740],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[4692764],"length":1,"stats":{"Line":1},"fn_name":null},{"line":39,"address":[4692809],"length":1,"stats":{"Line":1},"fn_name":null},{"line":44,"address":[4692928],"length":1,"stats":{"Line":0},"fn_name":"get_state"},{"line":45,"address":[4692937],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[4692976],"length":1,"stats":{"Line":1},"fn_name":"infect"},{"line":48,"address":[4692999],"length":1,"stats":{"Line":1},"fn_name":null},{"line":49,"address":[4693055],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[4693060],"length":1,"stats":{"Line":1},"fn_name":null},{"line":51,"address":[4693077],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[4693104],"length":1,"stats":{"Line":0},"fn_name":"update_age"},{"line":55,"address":[4693394,4693124],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[4693183],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[4693424,4693188,4693454],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[4693324],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[4693365],"length":1,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[4693456],"length":1,"stats":{"Line":1},"fn_name":"move_random"},{"line":63,"address":[4693495],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4693503,4693606],"length":1,"stats":{"Line":1},"fn_name":null},{"line":65,"address":[4693587],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[4693594],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[4693616],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[4693628],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[4694217,4693640],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[4693824,4694307],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[4693999],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[4694015],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[4694023],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[4694033],"length":1,"stats":{"Line":1},"fn_name":null},{"line":79,"address":[4694053],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[4694063],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[4694075],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[4694094,4694397],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[4694127],"length":1,"stats":{"Line":1},"fn_name":null},{"line":86,"address":[4694146,4694427,4694457],"length":1,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[4694177],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[4694197],"length":1,"stats":{"Line":1},"fn_name":null},{"line":91,"address":[4694464],"length":1,"stats":{"Line":1},"fn_name":"min_diff"},{"line":92,"address":[4694598,4694483],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[4694628,4694533,4694658],"length":1,"stats":{"Line":1},"fn_name":null},{"line":94,"address":[4694579],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[4694672],"length":1,"stats":{"Line":1},"fn_name":"sqr_distance"},{"line":98,"address":[4694696],"length":1,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[4694745],"length":1,"stats":{"Line":1},"fn_name":null},{"line":100,"address":[4694783,4694858],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":37,"coverable":47},{"path":["/","home","tomc","rust","sir","src","world","virus.rs"],"content":"\n#[derive(Clone, Debug)]\npub struct Virus {\n  pub distance: usize,\n  pub recovery_time: usize, // days\n  pub infection_rate: f32,  // between 0 and 1\n  pub mortality_rate: f32   // between 0 and 1\n}\n\nimpl Virus {\n  pub fn corona() -\u003e Virus {\n    Virus {\n      distance: 10,\n      recovery_time: 100,\n      infection_rate: 0.7,\n      mortality_rate: 0.05\n    }\n  }\n}","traces":[{"line":11,"address":[4219856],"length":1,"stats":{"Line":0},"fn_name":"corona"}],"covered":0,"coverable":1},{"path":["/","home","tomc","rust","sir","src","world","world.rs"],"content":"use super::person::{ Person, PersonState };\nuse super::virus::Virus;\n\npub struct World {\n  pub people: Vec\u003cPerson\u003e,\n  width: usize,\n  height: usize,\n  move_speed: usize,\n  virus: Option\u003cVirus\u003e\n}\n\nimpl World {\n  pub fn new(population: u32, width: usize, height: usize) -\u003e World {\n    let mut people: Vec\u003cPerson\u003e = Vec::new();\n    for _ in 1..population+1 {\n      people.push(Person::new_random(width, height))\n    }\n    people[0].infect(1.0);\n\n    let world = World {\n      people: people,\n      width,\n      height,\n      move_speed: 5,\n      virus: None\n    };\n    world\n  }\n  pub fn config(\u0026mut self, move_speed: usize) {\n    self.move_speed = move_speed;\n  }\n  pub fn set_virus(\u0026mut self, virus: \u0026Virus) {\n    self.virus = Some(virus.clone());\n  }\n  pub fn get_width(\u0026self) -\u003e usize {\n    self.width\n  }\n  pub fn get_height(\u0026self) -\u003e usize {\n    self.height\n  }\n  fn infect_closeby(people: \u0026mut Vec\u003cPerson\u003e, max_dist: usize, infection_rate: f32, width: usize, height: usize) {\n    let max_dist: isize = max_dist as isize;\n    for i in 0..people.len() {\n      for j in i+1..people.len() {\n        if people[i].get_state() == PersonState::Susceptible \u0026\u0026 people[j].get_state() == PersonState::Infectious {\n          let dist = people[i].sqr_distance(\u0026people[j], width, height);\n          if dist \u003c max_dist {\n            people[i].infect(infection_rate)\n          }\n        } else if people[j].get_state() == PersonState::Susceptible \u0026\u0026 people[i].get_state() == PersonState::Infectious {\n          let dist = people[i].sqr_distance(\u0026people[j], width, height);\n          if dist \u003c max_dist {\n            people[j].infect(infection_rate)\n          }\n        }\n      }\n    }\n  }\n  pub fn update(\u0026mut self) {\n    for person in self.people.iter_mut() {\n      person.move_random(self.move_speed, self.width, self.height);\n    }\n    if let Some(virus) = \u0026self.virus {\n      let max_dist = virus.distance * virus.distance;\n      World::infect_closeby(\u0026mut self.people, max_dist, virus.infection_rate, self.width, self.height);\n      for person in self.people.iter_mut() {\n        person.update_age(virus.recovery_time, virus.mortality_rate);\n      }\n    }\n  }\n}\n\n#[test]\nfn update_move_speed() {\n  let mut world = World::new(1, 100, 100);\n  world.config(15);\n  let mut person = world.people[0].clone();\n  let mut max_move = 0;\n  for _ in 1..1000 {\n    world.update();\n    let dist = person.sqr_distance(\u0026world.people[0], 100, 100);\n    if dist \u003e max_move {\n      max_move = dist;\n    }\n    person = world.people[0].clone();\n  }\n  // sqr_distance of 15 = (15^2 + 15^2)\n  assert_eq!(2 * 15 * 15, max_move);\n}\n","traces":[{"line":13,"address":[4905472,4905544],"length":1,"stats":{"Line":1},"fn_name":"new"},{"line":14,"address":[4905505],"length":1,"stats":{"Line":1},"fn_name":null},{"line":15,"address":[4905794,4906059,4905729,4905641,4905563],"length":1,"stats":{"Line":3},"fn_name":null},{"line":16,"address":[4905767],"length":1,"stats":{"Line":1},"fn_name":null},{"line":18,"address":[4905717,4905812],"length":1,"stats":{"Line":2},"fn_name":null},{"line":27,"address":[4906025],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[4906112],"length":1,"stats":{"Line":1},"fn_name":"config"},{"line":30,"address":[4906125],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[4906144],"length":1,"stats":{"Line":0},"fn_name":"set_virus"},{"line":33,"address":[4906158],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[4906272],"length":1,"stats":{"Line":0},"fn_name":"get_width"},{"line":36,"address":[4906277],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[4906288],"length":1,"stats":{"Line":0},"fn_name":"get_height"},{"line":39,"address":[4906293],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[4906304],"length":1,"stats":{"Line":0},"fn_name":"infect_closeby"},{"line":42,"address":[4906352],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[4906809,4906570,4906401],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[4907571,4906814,4906604],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[4906869,4907237,4907569],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[4907095],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[4907185,4907235],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[4907206],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[4907567,4907064,4907242],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[4907430],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[4907565,4907520],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[4907538],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[4907616],"length":1,"stats":{"Line":1},"fn_name":"update"},{"line":60,"address":[4907889,4907631,4907827],"length":1,"stats":{"Line":2},"fn_name":null},{"line":61,"address":[4907869],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[4907796,4907899,4908169],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4907918,4908267,4908237],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[4907979],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[4908029,4908171,4908227],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[4908210],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[4896645,4896640],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":75,"address":[4908279],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[4908338],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[4908403,4908357],"length":1,"stats":{"Line":2},"fn_name":null},{"line":78,"address":[4908410],"length":1,"stats":{"Line":1},"fn_name":null},{"line":79,"address":[4908668,4908422,4908878],"length":1,"stats":{"Line":2},"fn_name":null},{"line":80,"address":[4908699],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[4908718],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[4908779],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[4908794],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[4908814],"length":1,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[4908901,4908566],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":24,"coverable":46}]};
        var previousData = {"files":[{"path":["/","home","tomc","rust","sir","src","main.rs"],"content":"mod world;\nuse world::world::World;\nuse world::person::PersonState;\nuse world::virus::Virus;\nuse pixel_canvas::{Canvas, Color, input::MouseState, RC, image};\nuse std::time::{SystemTime};\n\nfn color_pixel(image: \u0026mut image::Image, x: isize, y: isize, state: \u0026world::person::PersonState) {\n    let width = image.width() as isize;\n    let height = image.height() as isize;\n    let size = 1;\n    for i in y-size..y+size+1 {\n        if i \u003e= 0 \u0026\u0026 i \u003c height {\n            for j in x-size..x+size+1 {\n                if j \u003e= 0 \u0026\u0026 j \u003c width {\n                    let mut pix: \u0026mut Color = \u0026mut image[RC(i as usize, j as usize)];\n                    match state {\n                        PersonState::Susceptible =\u003e pix.g = 255,\n                        PersonState::Infectious =\u003e pix.r = 255,\n                        PersonState::Recovered(false) =\u003e pix.b = 255,\n                        PersonState::Recovered(true) =\u003e {\n                            pix.r = 255;\n                            pix.g = 255;\n                            pix.b = 255;\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\nfn plot_graph(image: \u0026mut image::Image, stats: \u0026Vec\u003c(f32, f32, f32)\u003e, line_start: usize, line_end: usize) {\n    let width = image.width() as usize;\n    for (y, row) in image.chunks_mut(width).enumerate() {\n        for (x, pixel) in row.iter_mut().enumerate() {\n            if y \u003e line_start {\n                let mut r = 255;\n                let mut g = 255;\n                let mut b = 255;\n                if x \u003c stats.len() {\n                    let percent = 1.0 - ((line_end as f32) - (y as f32)) / ((line_end as f32) - (line_start as f32));\n                    if stats[x].1 \u003e percent {\n                        b = 0;\n                        g = 0;\n                    } else if stats[x].0 + stats[x].1 \u003e percent {\n                        r = 0;\n                        b = 0;\n                    } else {\n                        r = 0;\n                        g = 0;\n                    }\n                }\n                *pixel = Color { r, g, b };\n            }\n\n        }\n    }\n}\n\nfn main() {\n    let graph_size = 200;\n    let mut world = World::new(3000, 1920, 1080 - graph_size);\n    world.config(15);\n    let virus = Virus::corona();\n    world.set_virus(\u0026virus);\n\n    let canvas = Canvas::new(world.get_width(), world.get_height() + graph_size)\n        .title(\"World\")\n        .state(MouseState::new())\n        .input(MouseState::handle_input);\n\n    let mut now = SystemTime::now();\n    let mut stats: Vec\u003c(f32, f32, f32)\u003e = Vec::new();\n    // The canvas will render for you at up to 60fps.\n    canvas.render(move |_mouse, image| {\n        match now.elapsed() {\n            Ok(elapsed) =\u003e {\n                println!(\"{} ms\", elapsed.as_millis());\n            }\n            Err(e) =\u003e {\n                println!(\"Error: {:?}\", e);\n            }\n        }\n        now = SystemTime::now();\n        image.fill(Color {r: 0, g: 0, b: 0});\n\n        let mut count: (usize, usize, usize) = (0, 0, 0);\n        for person in world.people.iter_mut() {\n            color_pixel(image, person.position.x, person.position.y, \u0026person.get_state());\n            match person.get_state() {\n                PersonState::Susceptible =\u003e count.0 += 1,\n                PersonState::Infectious =\u003e count.1 += 1,\n                PersonState::Recovered(_dead) =\u003e count.2 += 1\n            }\n        };\n        let total = (count.0 + count.1 + count.2) as f32;\n        stats.push(((count.0 as f32) / total, (count.1 as f32) / total, (count.2 as f32) / total));\n        //println!(\"\u003e\u003e {:?} \", stats);\n        plot_graph(image, \u0026stats, world.get_height(), world.get_height() + graph_size);\n        world.update();\n    });\n}","traces":[{"line":8,"address":[4688640],"length":1,"stats":{"Line":0},"fn_name":"color_pixel"},{"line":9,"address":[4688711],"length":1,"stats":{"Line":0},"fn_name":null},{"line":10,"address":[4688749],"length":1,"stats":{"Line":0},"fn_name":null},{"line":11,"address":[4688773],"length":1,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[4689622,4688793,4689003],"length":1,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[4689037,4689311],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[4689109,4689617,4689717,4689316],"length":1,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[4689615,4689350],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[4689422],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[4689581,4689594,4689604],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[4689590,4689499],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[4689601],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[4689560,4689611],"length":1,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[4689570],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[4689573],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[4689577],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[4689808],"length":1,"stats":{"Line":0},"fn_name":"plot_graph"},{"line":34,"address":[4689879],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[4690122,4689909,4690489],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[4691224,4690316,4691219,4690494],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[4690573],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[4690592],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[4690600],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[4690608],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[4691149,4690624],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[4690670],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[4691048,4691147,4690976],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[4691032],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[4691040],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[4691055,4691129,4691020],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[4691131],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[4691139],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[4691113],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[4691121],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[4691151],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[4691305,4691232],"length":1,"stats":{"Line":0},"fn_name":"main"},{"line":62,"address":[4691239],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[4691320,4692139,4691275],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[4691363],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[4691378],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[4691398],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[4691410,4691558,4692189,4691621],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[4691597,4691539,4692069],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[4691628],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[4691636],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[4691711],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[4691718],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[4759675,4759263,4759430,4759783],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[4759302,4759432],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[4759462],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[4759324],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[4759354,4759685],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[4759785],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[4759838],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[4759918],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[4760185,4759962,4760544],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[4760219],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[4760311,4760480,4760526,4760434],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[4760323,4760436,4761243],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[4760482,4761213],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[4760536,4760382,4761183],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[4760557,4761273,4760144],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[4760671],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[4761333,4761025,4761363],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[4761161],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":65},{"path":["/","home","tomc","rust","sir","src","world","person.rs"],"content":"use rand::Rng;\nuse rand::rngs::ThreadRng;\nuse std::cmp;\n\n#[derive(Debug, PartialEq, Clone)]\npub enum PersonState {\n  Susceptible,\n  Infectious,\n  Recovered(bool)\n}\n\n#[derive(Clone, Debug)]\npub struct Location {\n  pub x: isize,\n  pub y: isize\n}\n\n#[derive(Debug, Clone)]\npub struct Person {\n  state: PersonState,\n  infected_date: isize,\n  age: isize,\n  pub position: Location,\n  home: Location,\n  rng: ThreadRng\n}\n\nimpl Person {\n  pub fn new_random(max_x: usize, max_y: usize) -\u003e Person {\n    let mut rng = rand::thread_rng();\n    let position = Location {\n      x: rng.gen_range(0, max_x as isize),\n      y: rng.gen_range(0, max_y as isize)\n    };\n    Person {\n      state: PersonState::Susceptible,\n      age: 0,\n      infected_date: 0,\n      home: position.clone(),\n      position,\n      rng\n    }\n  }\n  pub fn get_state(\u0026self) -\u003e PersonState {\n    self.state.clone()\n  }\n  pub fn infect(\u0026mut self, infection_rate: f32) {\n    let chance = self.rng.gen_range(0.0, 1.0);\n    if chance \u003c= infection_rate {\n      self.state = PersonState::Infectious;\n      self.infected_date = self.age;\n    }\n  }\n  pub fn update_age(\u0026mut self, max_infected_age: usize, mortality_rate: f32) {\n    self.age += 1;\n    let max_infected_age: isize = max_infected_age as isize;\n    if self.state == PersonState::Infectious \u0026\u0026 self.infected_date \u003c self.age - max_infected_age {\n      let chance = self.rng.gen_range(0.0, 1.0);\n      self.state = PersonState::Recovered(chance \u003c mortality_rate);\n    }\n  }\n  pub fn move_random(\u0026mut self, max_speed: usize, max_x: usize, max_y: usize) {\n    let mut max_speed: isize = max_speed as isize;\n    if let PersonState::Recovered(is_dead) = self.state {\n      if is_dead {\n        max_speed = 0\n      }\n    }\n    let x: isize = self.position.x as isize;\n    let y: isize = self.position.y as isize;\n\n    let mut new_x = x + self.rng.gen_range(-max_speed, max_speed+1);\n    let mut new_y = y + self.rng.gen_range(-max_speed, max_speed+1);\n    let max_x: isize = max_x as isize;\n    let max_y: isize = max_y as isize;\n    if new_x \u003e= max_x {\n      new_x = 0\n    };\n    if new_y \u003e= max_y {\n      new_y = 0\n    }\n    if new_x \u003c 0 {\n      new_x = max_x - 1;\n    };\n    if new_y  \u003c 0 {\n      new_y = max_y - 1;\n    }\n    self.position.x = new_x;\n    self.position.y = new_y;\n  }\n  fn min_diff(x1: isize, x2: isize, width: isize) -\u003e isize {\n    let diff_1 = (x1 - x2).abs();\n    let diff_2 = (diff_1 - width).abs();\n    std::cmp::min(diff_1, diff_2)\n  }\n  // We need the world to know its size because the world is circular\n  pub fn sqr_distance(\u0026self, other: \u0026Person, world_width: usize, world_height: usize) -\u003e isize {\n    let diff_x = Person::min_diff(self.position.x, other.position.x, world_width as isize);\n    let diff_y = Person::min_diff(self.position.y, other.position.y, world_height as isize);\n    return diff_x * diff_x + diff_y * diff_y;\n  }\n}","traces":[{"line":29,"address":[4692688],"length":1,"stats":{"Line":1},"fn_name":"new_random"},{"line":30,"address":[4692725],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[4692740],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[4692764],"length":1,"stats":{"Line":1},"fn_name":null},{"line":39,"address":[4692809],"length":1,"stats":{"Line":1},"fn_name":null},{"line":44,"address":[4692928],"length":1,"stats":{"Line":0},"fn_name":"get_state"},{"line":45,"address":[4692937],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[4692976],"length":1,"stats":{"Line":1},"fn_name":"infect"},{"line":48,"address":[4692999],"length":1,"stats":{"Line":1},"fn_name":null},{"line":49,"address":[4693055],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[4693060],"length":1,"stats":{"Line":1},"fn_name":null},{"line":51,"address":[4693077],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[4693104],"length":1,"stats":{"Line":0},"fn_name":"update_age"},{"line":55,"address":[4693394,4693124],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[4693183],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[4693454,4693188,4693424],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[4693324],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[4693365],"length":1,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[4693456],"length":1,"stats":{"Line":1},"fn_name":"move_random"},{"line":63,"address":[4693495],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4693503,4693606],"length":1,"stats":{"Line":1},"fn_name":null},{"line":65,"address":[4693587],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[4693594],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[4693616],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[4693628],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[4693640,4694217],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[4694307,4693824],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[4693999],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[4694015],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[4694023],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[4694033],"length":1,"stats":{"Line":1},"fn_name":null},{"line":79,"address":[4694053],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[4694063],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[4694075],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[4694094,4694397],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[4694127],"length":1,"stats":{"Line":1},"fn_name":null},{"line":86,"address":[4694427,4694146,4694457],"length":1,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[4694177],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[4694197],"length":1,"stats":{"Line":1},"fn_name":null},{"line":91,"address":[4694464],"length":1,"stats":{"Line":1},"fn_name":"min_diff"},{"line":92,"address":[4694598,4694483],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[4694533,4694658,4694628],"length":1,"stats":{"Line":1},"fn_name":null},{"line":94,"address":[4694579],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[4694672],"length":1,"stats":{"Line":1},"fn_name":"sqr_distance"},{"line":98,"address":[4694696],"length":1,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[4694745],"length":1,"stats":{"Line":1},"fn_name":null},{"line":100,"address":[4694783,4694858],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":37,"coverable":47},{"path":["/","home","tomc","rust","sir","src","world","virus.rs"],"content":"\n#[derive(Clone, Debug)]\npub struct Virus {\n  pub distance: usize,\n  pub recovery_time: usize, // days\n  pub infection_rate: f32,  // between 0 and 1\n  pub mortality_rate: f32   // between 0 and 1\n}\n\nimpl Virus {\n  pub fn corona() -\u003e Virus {\n    Virus {\n      distance: 10,\n      recovery_time: 100,\n      infection_rate: 0.7,\n      mortality_rate: 0.05\n    }\n  }\n}","traces":[{"line":11,"address":[4219856],"length":1,"stats":{"Line":0},"fn_name":"corona"}],"covered":0,"coverable":1},{"path":["/","home","tomc","rust","sir","src","world","world.rs"],"content":"use super::person::{ Person, PersonState };\nuse super::virus::Virus;\n\npub struct World {\n  pub people: Vec\u003cPerson\u003e,\n  width: usize,\n  height: usize,\n  move_speed: usize,\n  virus: Option\u003cVirus\u003e\n}\n\nimpl World {\n  pub fn new(population: u32, width: usize, height: usize) -\u003e World {\n    let mut people: Vec\u003cPerson\u003e = Vec::new();\n    for _ in 1..population+1 {\n      people.push(Person::new_random(width, height))\n    }\n    people[0].infect(1.0);\n\n    let world = World {\n      people: people,\n      width,\n      height,\n      move_speed: 5,\n      virus: None\n    };\n    world\n  }\n  pub fn config(\u0026mut self, move_speed: usize) {\n    self.move_speed = move_speed;\n  }\n  pub fn set_virus(\u0026mut self, virus: \u0026Virus) {\n    self.virus = Some(virus.clone());\n  }\n  pub fn get_width(\u0026self) -\u003e usize {\n    self.width\n  }\n  pub fn get_height(\u0026self) -\u003e usize {\n    self.height\n  }\n  fn infect_closeby(people: \u0026mut Vec\u003cPerson\u003e, max_dist: usize, infection_rate: f32, width: usize, height: usize) {\n    let max_dist: isize = max_dist as isize;\n    for i in 0..people.len() {\n      for j in i+1..people.len() {\n        if people[i].get_state() == PersonState::Susceptible \u0026\u0026 people[j].get_state() == PersonState::Infectious {\n          let dist = people[i].sqr_distance(\u0026people[j], width, height);\n          if dist \u003c max_dist {\n            people[i].infect(infection_rate)\n          }\n        } else if people[j].get_state() == PersonState::Susceptible \u0026\u0026 people[i].get_state() == PersonState::Infectious {\n          let dist = people[i].sqr_distance(\u0026people[j], width, height);\n          if dist \u003c max_dist {\n            people[j].infect(infection_rate)\n          }\n        }\n      }\n    }\n  }\n  pub fn update(\u0026mut self) {\n    for person in self.people.iter_mut() {\n      person.move_random(self.move_speed, self.width, self.height);\n    }\n    if let Some(virus) = \u0026self.virus {\n      let max_dist = virus.distance * virus.distance;\n      World::infect_closeby(\u0026mut self.people, max_dist, virus.infection_rate, self.width, self.height);\n      for person in self.people.iter_mut() {\n        person.update_age(virus.recovery_time, virus.mortality_rate);\n      }\n    }\n  }\n}\n\n#[test]\nfn update_move_speed() {\n  let mut world = World::new(1, 100, 100);\n  world.config(15);\n  let mut person = world.people[0].clone();\n  let mut max_move = 0;\n  for _ in 1..1000 {\n    world.update();\n    let dist = person.sqr_distance(\u0026world.people[0], 100, 100);\n    if dist \u003e max_move {\n      max_move = dist;\n    }\n    person = world.people[0].clone();\n  }\n  // sqr_distance of 15 = (15^2 + 15^2)\n  assert_eq!(2 * 15 * 15, max_move);\n}\n","traces":[{"line":13,"address":[4905544,4905472],"length":1,"stats":{"Line":1},"fn_name":"new"},{"line":14,"address":[4905505],"length":1,"stats":{"Line":1},"fn_name":null},{"line":15,"address":[4905641,4905729,4906059,4905563,4905794],"length":1,"stats":{"Line":3},"fn_name":null},{"line":16,"address":[4905767],"length":1,"stats":{"Line":1},"fn_name":null},{"line":18,"address":[4905812,4905717],"length":1,"stats":{"Line":2},"fn_name":null},{"line":27,"address":[4906025],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[4906112],"length":1,"stats":{"Line":1},"fn_name":"config"},{"line":30,"address":[4906125],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[4906144],"length":1,"stats":{"Line":0},"fn_name":"set_virus"},{"line":33,"address":[4906158],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[4906272],"length":1,"stats":{"Line":0},"fn_name":"get_width"},{"line":36,"address":[4906277],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[4906288],"length":1,"stats":{"Line":0},"fn_name":"get_height"},{"line":39,"address":[4906293],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[4906304],"length":1,"stats":{"Line":0},"fn_name":"infect_closeby"},{"line":42,"address":[4906352],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[4906401,4906809,4906570],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[4906604,4906814,4907571],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[4907237,4906869,4907569],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[4907095],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[4907235,4907185],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[4907206],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[4907242,4907064,4907567],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[4907430],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[4907520,4907565],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[4907538],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[4907616],"length":1,"stats":{"Line":1},"fn_name":"update"},{"line":60,"address":[4907889,4907827,4907631],"length":1,"stats":{"Line":2},"fn_name":null},{"line":61,"address":[4907869],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[4907796,4907899,4908169],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[4908267,4907918,4908237],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[4907979],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[4908029,4908171,4908227],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[4908210],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[4896640,4896645],"length":1,"stats":{"Line":3},"fn_name":"{{closure}}"},{"line":75,"address":[4908279],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[4908338],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[4908403,4908357],"length":1,"stats":{"Line":2},"fn_name":null},{"line":78,"address":[4908410],"length":1,"stats":{"Line":1},"fn_name":null},{"line":79,"address":[4908422,4908668,4908878],"length":1,"stats":{"Line":2},"fn_name":null},{"line":80,"address":[4908699],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[4908718],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[4908779],"length":1,"stats":{"Line":1},"fn_name":null},{"line":83,"address":[4908794],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[4908814],"length":1,"stats":{"Line":1},"fn_name":null},{"line":88,"address":[4908566,4908901],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":24,"coverable":46}]};
    </script>
    <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, pathToString(file.path)),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('div', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('pre', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>